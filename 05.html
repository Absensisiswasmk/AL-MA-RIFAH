<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absen Digital Interaktif SMKS AL-MA'RIFAH GEMPOL</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Variable Warna */
        :root {
            --color-primary: #1e88e5; 
            --color-dark: #0d47a1; 
            --color-green: #4caf50;
            --color-red: #f44336;
            --color-text: #333;
            --color-light-bg: #f5f5f5;
            --color-danger: #dc3545; /* Merah untuk Hapus Permanen */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-light-bg);
            color: var(--color-text);
        }

        /* HEADER */
        .header-blue {
            background-color: var(--color-dark);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-blue h1 {
            margin: 0 0 5px 0;
            font-size: 2em;
        }

        .header-blue p {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* FORM GROUP & KONTROL */
        .form-group-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 10px;
            background-color: #e3f2fd; 
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-control label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--color-dark);
        }

        .form-control input, .form-control select {
            width: 100%;
            padding: 10px;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: white;
            transition: border-color 0.3s;
        }
        
        .form-control input:focus, .form-control select:focus {
            border-color: var(--color-primary);
            outline: none;
        }

        /* MENU HORIZONTAL */
        .nav-tabs {
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            display: flex; 
        }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            flex-grow: 1; 
            text-align: center;
        }

        .tab-button:hover:not(.active) {
            color: var(--color-primary);
        }

        .tab-button.active {
            color: var(--color-primary);
            border-bottom: 3px solid var(--color-primary);
            background-color: #f7f7f7; 
        }
        /* END MENU HORIZONTAL */

        /* TAB KELAS */
        .class-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .class-btn {
            padding: 8px 15px;
            border: 1px solid var(--color-primary);
            background-color: white;
            color: var(--color-primary);
            border-radius: 50px; 
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .class-btn:hover {
            background-color: #e3f2fd;
        }

        .class-btn.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 2px 5px rgba(30, 136, 229, 0.5);
        }

        .add-student-btn {
            padding: 8px 15px;
            background-color: var(--color-dark);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-left: auto; 
            transition: background-color 0.2s;
        }
        
        .add-student-btn:hover {
            background-color: #002661;
        }


        /* TABEL ABSENSI & REKAP */
        .attendance-table, .rekap-table, .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        /* Gaya Baris Rekap Utama */
        .rekap-table tbody tr {
            cursor: pointer; 
            transition: background-color 0.1s;
        }
        .rekap-table tbody tr:hover {
            background-color: #e3f2fd;
        }

        .attendance-table th, .rekap-table th, .detail-table th {
            background-color: var(--color-primary);
            color: white;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #1976d2;
        }
        
        .rekap-table th:nth-child(8) {
            background-color: #fdd835; /* Warna kuning agar menonjol */
            color: var(--color-dark);
        }
        
        .attendance-table th:nth-child(2), .rekap-table th:nth-child(2), .detail-table th:nth-child(2) {
            text-align: left;
        }

        .attendance-table td, .rekap-table td, .detail-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .detail-table td:nth-child(2) {
            text-align: left;
        }
        
        .rekap-table td:nth-child(2) {
            text-align: left;
            font-weight: bold;
        }


        .attendance-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .attendance-table tbody tr:hover {
            background-color: #e3f2fd;
        }

        /* Kolom nama siswa */
        .attendance-table td:nth-child(2) { 
            text-align: left;
            font-weight: 500;
        }
        
        /* Kolom Keterangan */
        .attendance-table td:last-child input[type="text"] {
            width: 90%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        /* Radio Button Styling */
        .attendance-table td input[type="radio"] {
            transform: scale(1.3);
            cursor: pointer;
        }

        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }
        
        .btn-edit {
            background-color: orange;
            color: white;
        }

        .btn-green {
            background-color: var(--color-green);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--color-danger);
            color: white;
        }

        .btn-red {
            background-color: var(--color-red);
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-full-width {
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            font-size: 1.1em;
        }

        .action-bar, .action-bar-rekap {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Bar Hapus Data di Rekap */
        .delete-bar {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8d7da; /* Light Red */
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            text-align: center;
        }


        /* NOTIFIKASI */
        .notification-box {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* DETAIL BOX */
        .detail-box {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--color-primary);
            border-radius: 8px;
            background-color: #e3f2fd;
            display: none; /* Default hidden */
        }
        
        .detail-box h3 {
            color: var(--color-dark);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
        }
        
        /* New Rekap Table Styling */
        .rekap-table th:nth-child(1) { width: 5%; }
        .rekap-table th:nth-child(2) { width: 30%; }


        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>

    <header class="header-blue">
        <h1>SMKS AL-MA'RIFAH GEMPOL</h1>
        <p>Jl.Pejagan Asem 02/01 Ds.kedung bunder Kec.Gempol Kab.Cirebon 45161</p>
    </header>

    <div class="container">
        
        <div class="nav-tabs">
            <button class="tab-button active" onclick="showPage('absensi', this)"><i class="fas fa-user-check"></i> Absensi Hari Ini</button>
            <button class="tab-button" onclick="showPage('rekap', this)"><i class="fas fa-chart-bar"></i> Rekapitulasi Kehadiran</button>
        </div>

        <div id="absensi" class="page active">
            <h2>üìù Input Absensi Harian</h2>
            <div id="edit-mode-notification" class="notification-box warning" style="display:none;">
                <i class="fas fa-exclamation-triangle"></i> Anda sedang dalam **MODE EDIT**. Silakan perbarui data di bawah dan klik **SIMPAN PEMBARUAN**.
            </div>

            <div class="form-group-grid">
                <div class="form-control">
                    <label for="guru">Guru Pengajar:</label>
                    <select id="guru">
                        <option value="Muhamad Saefullah, S.Kom">Muhamad Saefullah, S.Kom</option>
                        <option value="Lili Muzdalifah, S.Kom, Gr">Lili Muzdalifah, S.Kom, Gr</option>
                        <option value="Narjiman, S.Pd.i, Gr">Narjiman, S.Pd.i, Gr</option>
                        <option value="Afandi Jarkasi, S.Kom, MM, Gr">Afandi Jarkasi, S.Kom, MM, Gr</option>
                        <option value="Nani Sumarni, S.Pd.i, Gr">Nani Sumarni, S.Pd.i, Gr</option>
                        <option value="Aan Hermawan, S.Kom">Aan Hermawan, S.Kom</option>
                        <option value="Hafip Zaenudin, S.Kom">Hafip Zaenudin, S.Kom</option>
                        <option value="Tatang Sujana, S.Kom">Tatang Sujana, S.Kom</option>
                        <option value="Abdullah Khaeru Ramadhan, S.Kom">Abdullah Khaeru Ramadhan, S.Kom</option>
                        <option value="Muhammad Syafiq Farhan, S.Pd">Muhammad Syafiq Farhan, S.Pd</option>
                        <option value="Aminah, SE, M.Pd">Aminah, SE, M.Pd</option>
                        <option value="Nihayatul Khusniah, S.Pd">Nihayatul Khusniah, S.Pd</option>
                        <option value="Nida Lyalin, S.Pd">Nida Lyalin, S.Pd</option>
                        <option value="Siti Markhamah, S.Pd">Siti Markhamah, S.Pd</option>
                        <option value="Rizal Ainnur Rahman, S.Kom">Rizal Ainnur Rahman, S.Kom</option>
                        <option value="Ilva Minatika, Amd.Kom">Ilva Minatika, Amd.Kom</option>
                        <option value="Nati Yulia Sari, SE">Nati Yulia Sari, SE</option>
                        <option value="Fauzi Ramdani">Fauzi Ramdani</option>
                        <option value="Undi Erlangga, SS">Undi Erlangga, SS</option>
                    </select>
                </div>
                <div class="form-control">
                    <label for="mapel">Mata Pelajaran:</label>
                    <select id="mapel">
                        <option value="Bhs Indonesia">Bhs Indonesia</option>
                        <option value="Pend. Pancasila">Pend. Pancasila</option>
                        <option value="Matematika">Matematika</option>
                        <option value="Sejarah">Sejarah</option>
                        <option value="Bhs Inggris">Bhs Inggris</option>
                        <option value="PAI">PAI</option>
                        <option value="Bhs Jepang">Bhs Jepang</option>
                        <option value="Seni Rupa">Seni Rupa</option>
                        <option value="AIJ">AIJ</option>
                        <option value="PKK">PKK</option>
                        <option value="Penjas">Penjas</option>
                        <option value="Dasar2 Program Keahlian">Dasar2 Program Keahlian</option>
                        <option value="Adm Sistem Jaringan">Adm Sistem Jaringan</option>
                        <option value="Sistem Komputer">Sistem Komputer</option>
                        <option value="IPAS">IPAS</option>
                        <option value="Informatika">Informatika</option>
                        <option value="Teklajar">Teklajar</option>
                        <option value="IOT">IOT</option>
                        <option value="Digital Marketing">Digital Marketing</option>
                    </select>
                </div>
                <div class="form-control">
                    <label for="jamke">Jam Pertemuan (1-8 Jam):</label>
                    <input type="number" id="jamke" value="1" min="1" max="8">
                </div>
                <div class="form-control">
                    <label for="tanggal">Tanggal:</label>
                    <input type="date" id="tanggal" required>
                </div>
            </div>

            <div class="class-selector">
                <button class="class-btn active" data-class="X">Kelas X</button>
                <button class="class-btn" data-class="XI-1">Kelas XI-1</button>
                <button class="class-btn" data-class="XI-2">Kelas XI-2</button>
                <button class="class-btn" data-class="XII">Kelas XII</button>
                <button class="add-student-btn" onclick="tambahSiswaModal()"><i class="fas fa-user-plus"></i> Tambah Siswa</button>
            </div>

            <div class="action-bar">
                <button class="btn btn-green" onclick="setHadirSemua()"><i class="fas fa-check-double"></i> HADIR SEMUA</button>
            </div>
            
            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Siswa</th>
                        <th>Hadir (H)</th>
                        <th>Izin (I)</th>
                        <th>Sakit (S)</th>
                        <th>Absen (A)</th>
                        <th>Bolos (B)</th>
                        <th>Keterangan</th>
                    </tr>
                </thead>
                <tbody id="attendance-list">
                    </tbody>
            </table>
            
            <button class="btn btn-primary btn-full-width" id="simpan-absensi-btn" onclick="simpanAbsensi()"><i class="fas fa-paper-plane"></i> Kirim/Simpan Absen</button>
            <div id="save-notification" class="notification-box success" style="display:none;"></div>
        </div>

        <div id="rekap" class="page" style="display:none;">
            <h2>üìà Rekapitulasi Kehadiran Siswa Per Kelas</h2>
            
            <div class="form-group-grid">
                <div class="form-control">
                    <label for="rekap-jenis">Jenis Rekap:</label>
                    <select id="rekap-jenis">
                        <option>Harian</option>
                        <option>Mingguan</option>
                        <option>Bulanan</option>
                        <option>Tahunan</option>
                    </select>
                </div>
                <div class="form-control">
                    <label for="rekap-kelas">Kelas:</label>
                    <select id="rekap-kelas">
                        <option value="X">X</option><option value="XI-1">XI-1</option><option value="XI-2">XI-2</option><option value="XII">XII</option>
                    </select>
                </div>
                <div class="form-control">
                    <label for="rekap-tanggal-mulai">Tgl. Mulai (Untuk Rekap):</label>
                    <input type="date" id="rekap-tanggal-mulai">
                </div>
                <div class="form-control">
                    <label for="rekap-tanggal-akhir">Tgl. Akhir (Untuk Rekap):</label>
                    <input type="date" id="rekap-tanggal-akhir">
                </div>
            </div>
            
            <div class="action-bar-rekap">
                <button class="btn btn-primary" onclick="memuatRekapan()"><i class="fas fa-sync-alt"></i> Muat Rekapan</button>
                <button class="btn btn-green" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Unduh Excel</button>
                <button class="btn btn-red" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Unduh PDF</button>
                <button class="btn btn-secondary" onclick="cetakOtomatis()"><i class="fas fa-print"></i> Cetak Otomatis</button>
            </div>

            <table class="rekap-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Siswa (Klik untuk Detail)</th>
                        <th>Total Hadir</th>
                        <th>Total Izin</th>
                        <th>Total Sakit</th>
                        <th>Total Absen (Alfa)</th>
                        <th>Total Bolos</th>
                        <th>Total Absen (Jam)</th> <th>Aksi Terakhir</th>
                    </tr>
                </thead>
                <tbody id="rekap-body">
                    <tr><td colspan="9">Klik 'Muat Rekapan' untuk melihat data.</td></tr> </tbody>
            </table>
            
            <div id="detail-absensi" class="detail-box">
                </div>
            
            <div class="delete-bar">
                <p style="font-weight: bold; color: var(--color-danger); margin: 0;">PERINGATAN: Zona Berbahaya</p>
                <button class="btn btn-danger" onclick="clearAllAbsences()"><i class="fas fa-trash-alt"></i> Hapus Semua Data Permanen</button>
            </div>
            <div id="delete-notification" class="notification-box alert-danger" style="display:none;"></div>
            
        </div>

    </div>

    <script>
        // Data Siswa (Sesuai permintaan Anda)
        const studentData = {
            'X': [
                'AKMAL WIRDANSAH', 'AMANDA SISKA FIRINA', 'ARIANI MUTIA ATMANAGARA', 'ARINA NABILATUZ ZAHRA',
                'AUFA ABDUL MUTHI', 'AULIA IZZATUNISA', 'AURELL LUQMAN', 'BANU RAZIQ YUSUF', 'DEDE SOBARI',
                'DIANA HADAWIYAH', 'FERI ARDIANSYAH', 'HABIB DZAKI AWALUL SULTON', 'HIKMAH ROHMATILLAH',
                'INTAN MAHARANI', 'JESIKA ANGGRAENI', 'M. HAIKAL RIZKI', 'MUHAMAD IKHSAN', 'M. JARKASI NUR',
                'M. SYARIF HIDAYATULLAH', 'NISHREEN NAZILAH MUMTAZAH', 'NURUL ARIF RAHMAN', 'PUTRA HABIBURROHMAN',
                'RENDI JAMIL AFRIYANDI', 'SAEPUL RAMDAN', 'SLAMET RIYADI', 'SYEKH HAKIN NAJELI', 'SYIFA SALSABILA AS-SHOFI',
                'YOGA BAGUS SADEWO', 'M. RIZKI MAULANA'
            ],
            'XI-1': [
                'AGHISNA HELMALIA AZMI', 'ALDI HARDIANSYAH', 'ALYA LAUDYA HAMZAH', 'ANISA RAHMADANI ASTORI',
                'ATEP ALIYUDIN', 'CAWIDANA', 'ICHA MINATUL MAULA', 'ICHA VARIATUN NISA', 'IMAM MAHDI AL-GHOZALI',
                'INDRI LESTARI', 'IQTIDAR ZAAIDAN', 'KAMALIA AL KAISA', 'LUTHFIYAH PUTRI', 'MUHAMAD CHAMALIN',
                'M. PRADITYA FAKHRI ASYAWALI', 'M. WILDAN FIRDAUS', 'NAZWA SYAFIRA', 'SAHRUL ALWI',
                'TIYAS NUR KHOTIMAH', 'TRIO ANFAUL MU\'MIN', 'TSANIATUL WADA\'I', 'VAIZUL LAILATURRAHMAN',
                'WIDYA PUTRI'
            ],
            'XI-2': [
                'ABDUL ISFARON KHOIR', 'ABDUL ROZAQ', 'AUDI ALFARIZI', 'BAYU MAKDIS DARUSSALAM', 'FITRI APRILIYANI',
                'HADZELLIYA FEBRIANI', 'HAFIZ AHMAD FATAH', 'INAYATUL DZIL IZZATI', 'IRWAN DERMAWAN', 'ISMATURROHMAN',
                'JAKA', 'JAYA', 'KEYLA MAUDI ANGGRAENI', 'MAULANA IMRON', 'MUHAEMIN FATRUROJI', 'MUHAMAD APIVI',
                'M. ASROR FATHONY', 'M. RIZAL FADLI', 'M. ZIO RAMADHANI', 'NAJMA LAILA', 'RIZKI MAULANA',
                'SARIFA ANIS', 'WIWIN WAHYUDI', 'M. NUR ROYYAN'
            ],
            'XII': [
                'AA KURNIAWAN', 'AFNAN IRSYAD ARDIANSYAH', 'AGNI TRISA PUTRI', 'AHNAF', 'ANDINI', 'ANJANI SALSABILA',
                'ARDILA RIZKA MIRANTI', 'ARIF RAHMAT', 'DEDE ARYAN', 'ELVAN FAUZAN AHMAD AL ANSHORI', 'FAJAR AFRIYADI',
                'FITRA FADILLAH', 'HUZROTUN NISA', 'ILHAM MAULANA', 'INDRI NOVA DIYANA', 'IQBAL SAEFULLAH',
                'KURNIAWAN', 'M.FAQIH', 'MUHAMMAD FAJAR', 'M. SYARIF HASAN', 'NADA SAFFANAH BILQIES',
                'NINA KHOEROTUN NISA', 'RIDHO FEBRIAN', 'ROMADONI SAEFUDIN', 'SITI ROIHANATUL AMALIYAH'
            ]
        };

        let activeClass = 'X'; 
        let storedAbsences = []; // Akan dimuat dari localStorage
        let isEditMode = false;
        let recordToEditId = null;
        
        const LOCAL_STORAGE_KEY = 'absensiSMK_data';
        const MAX_DAILY_HOURS = 8; // Batas maksimum jam absen per hari

        // --- FUNGSI LOCAL STORAGE ---
        function loadAbsences() {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            storedAbsences = stored ? JSON.parse(stored) : [];
        }

        function saveAbsences() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(storedAbsences));
        }

        // --- FUNGSI UTAMA RENDERING ---

        function showPage(pageId, button) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
                page.classList.remove('active');
            });
            document.getElementById(pageId).style.display = 'block';
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
        }


        function renderAttendanceTable(className, detailData = null) {
            const tableBody = document.getElementById('attendance-list');
            tableBody.innerHTML = '';
            const students = studentData[className] || [];

            students.forEach((name, index) => {
                const row = tableBody.insertRow();
                const no = index + 1;
                const statusOptions = ['H', 'I', 'S', 'A', 'B']; 
                let savedStatus = 'H';
                let savedKeterangan = '';

                if (detailData) {
                    const studentDetail = detailData.detail.find(d => d.nama === name);
                    if (studentDetail) {
                        savedStatus = studentDetail.status;
                        savedKeterangan = studentDetail.keterangan || '';
                    }
                }

                row.insertCell().textContent = no;
                row.insertCell().textContent = name;

                statusOptions.forEach(status => {
                    const cell = row.insertCell();
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `status-${className}-${no}`;
                    input.value = status;

                    if (status === savedStatus) {
                        input.checked = true;
                    } else if (!detailData && status === 'H') {
                        // Secara default, radio 'H' terpilih saat load baru
                        input.checked = true;
                    }

                    cell.appendChild(input);
                });

                const ketCell = row.insertCell();
                const inputKet = document.createElement('input');
                inputKet.type = 'text';
                inputKet.placeholder = 'Keterangan';
                inputKet.value = savedKeterangan;
                ketCell.appendChild(inputKet);
            });

            document.querySelectorAll('.class-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`.class-btn[data-class="${className}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Handler untuk memilih kelas
        document.querySelectorAll('.class-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                activeClass = e.target.dataset.class;
                renderAttendanceTable(activeClass);
            });
        });

        // --- LOGIKA ABSENSI DAN EDIT ---

        function setHadirSemua() {
            const radios = document.querySelectorAll(`#attendance-list input[type="radio"][value="H"]`);
            radios.forEach(radio => {
                radio.checked = true;
            });
        }

        function simpanAbsensi() {
            const rows = document.getElementById('attendance-list').rows;
            
            const guru = document.getElementById('guru').value;
            const mapel = document.getElementById('mapel').value;
            const jamke = document.getElementById('jamke').value;
            const tanggal = document.getElementById('tanggal').value;

            if (!guru || !mapel || !jamke || !tanggal) {
                alert('Mohon lengkapi semua data form (Guru, Mapel, Jam, dan Tanggal).');
                return;
            }
            if (parseInt(jamke) < 1 || parseInt(jamke) > MAX_DAILY_HOURS) {
                alert(`Jam Pertemuan harus antara 1 sampai ${MAX_DAILY_HOURS} jam.`);
                return;
            }

            let count = { H: 0, I: 0, S: 0, A: 0, B: 0 };
            let detailSiswa = [];
            const jamkeInt = parseInt(jamke);

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const nama = row.cells[1].textContent;
                const statusInput = row.querySelector(`input[name="status-${activeClass}-${i+1}"]:checked`);
                const keterangan = row.cells[7].querySelector('input[type="text"]').value;
                
                // Status default adalah 'A' (Absen/Alfa) jika tidak ada radio button yang dipilih
                let status = statusInput ? statusInput.value : 'A'; 
                count[status]++; // Menghitung Sesi Kehadiran/Ketidakhadiran

                let jamAbsen = 0;
                
                // LOGIKA PENGHITUNGAN JAM ABSEN
                if (status === 'H') {
                    // Hadir: 0 Jam Absen
                    jamAbsen = 0; 
                } else if (status === 'I' || status === 'S' || status === 'A') {
                    // Izin, Sakit, atau Absen (termasuk yang Belum Diisi): Dihitung 1 Jam Absen
                    jamAbsen = 1; 
                } else if (status === 'B') {
                    // Bolos: Dihitung sesuai Jam Pertemuan (jamke), maksimal 8 Jam.
                    jamAbsen = Math.min(jamkeInt, MAX_DAILY_HOURS); 
                }
                
                detailSiswa.push({ 
                    nama: nama, 
                    status: status, 
                    keterangan: keterangan,
                    jamAbsen: jamAbsen // Nilai yang akan direkap kumulatif
                });
            }
            
            const totalJamAbsen = detailSiswa.reduce((sum, s) => sum + s.jamAbsen, 0);

            const newRecord = {
                id: isEditMode ? recordToEditId : Date.now(), 
                tanggal: tanggal,
                kelas: activeClass,
                mapel: mapel,
                guru: guru,
                jamke: jamkeInt,
                counts: count, 
                totalJamAbsen: totalJamAbsen, // Disimpan di record
                detail: detailSiswa
            };

            let notificationText = '';

            if (isEditMode) {
                const index = storedAbsences.findIndex(r => r.id === recordToEditId);
                if (index !== -1) {
                    storedAbsences[index] = newRecord;
                }
                resetEditMode();
                notificationText = `Data absensi Kelas ${activeClass} (${mapel}) Berhasil **DIPERBARUI**!`;
            } else {
                storedAbsences.unshift(newRecord); 
                notificationText = `Absensi Kelas ${activeClass} (${mapel} - ${tanggal}) Berhasil Disimpan! ‚úîÔ∏è Data telah terekap.`;
            }
            
            // --- SIMPAN KE LOCAL STORAGE ---
            saveAbsences();

            const notification = document.getElementById('save-notification');
            notification.innerHTML = notificationText;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
            
            // Reset tabel ke Hadir Semua untuk input sesi baru
            setHadirSemua(); 
        }
        
        function setEditMode(record) {
            isEditMode = true;
            recordToEditId = record.id;
            
            showPage('absensi', document.querySelector('.tab-button'));
            
            document.getElementById('guru').value = record.guru;
            document.getElementById('mapel').value = record.mapel;
            document.getElementById('jamke').value = record.jamke;
            document.getElementById('tanggal').value = record.tanggal;
            activeClass = record.kelas; 
            
            renderAttendanceTable(record.kelas, record);
            
            document.getElementById('simpan-absensi-btn').innerHTML = `<i class="fas fa-edit"></i> Simpan Pembaruan`;
            document.getElementById('simpan-absensi-btn').classList.add('btn-edit');
            document.getElementById('simpan-absensi-btn').classList.remove('btn-primary');
            
            document.getElementById('edit-mode-notification').style.display = 'block';
        }

        function resetEditMode() {
            isEditMode = false;
            recordToEditId = null;
            
            document.getElementById('simpan-absensi-btn').innerHTML = `<i class="fas fa-paper-plane"></i> Kirim/Simpan Absen`;
            document.getElementById('simpan-absensi-btn').classList.add('btn-primary');
            document.getElementById('simpan-absensi-btn').classList.remove('btn-edit');
            
            document.getElementById('edit-mode-notification').style.display = 'none';
        }

        function tambahSiswaModal() {
            const newStudentName = prompt(`Masukkan Nama Siswa Baru untuk Kelas ${activeClass}:`);
            if (newStudentName && newStudentName.trim() !== "") {
                const formattedName = newStudentName.trim().toUpperCase();
                studentData[activeClass].push(formattedName);
                renderAttendanceTable(activeClass); 
                alert(`Siswa ${formattedName} berhasil ditambahkan ke Kelas ${activeClass}. Catatan: Penambahan ini hanya berlaku di sesi ini, tidak tersimpan permanen.`);
            }
        }

        // --- REKAPITULASI ---

        function memuatRekapan() {
            const rekapBody = document.getElementById('rekap-body');
            rekapBody.innerHTML = '';
            
            document.getElementById('detail-absensi').style.display = 'none';
            
            const selectedClass = document.getElementById('rekap-kelas').value;
            const allRecords = storedAbsences.filter(rec => rec.kelas === selectedClass);
            
            if (allRecords.length === 0) {
                // COLSPAN DIUBAH KE 9
                rekapBody.innerHTML = `<tr><td colspan="9">Belum ada data absensi tersimpan untuk Kelas ${selectedClass}.</td></tr>`; 
                return;
            }
            
            let studentSummary = {};
            const studentsInClass = studentData[selectedClass] || [];
            
            studentsInClass.forEach(name => {
                studentSummary[name] = {
                    H: 0, I: 0, S: 0, A: 0, B: 0, jamAbsenKumulatif: 0, lastRecordId: null 
                };
            });

            allRecords.forEach(record => {
                record.detail.forEach(siswaDetail => {
                    const name = siswaDetail.nama;
                    if (studentSummary[name]) {
                        studentSummary[name][siswaDetail.status]++;
                        // Mengakumulasi total jam absen
                        studentSummary[name].jamAbsenKumulatif += siswaDetail.jamAbsen; 
                        
                        // Simpan ID record sesi terbaru untuk tombol edit
                        const currentRecordTime = new Date(record.tanggal).getTime();
                        let lastRecordTime = 0;
                        if (studentSummary[name].lastRecordId) {
                            const lastRecord = storedAbsences.find(r => r.id === studentSummary[name].lastRecordId);
                            if (lastRecord) lastRecordTime = new Date(lastRecord.tanggal).getTime();
                        }
                        
                        // Logika untuk menentukan record terakhir berdasarkan tanggal dan ID (timestamp)
                        if (!studentSummary[name].lastRecordId || currentRecordTime >= lastRecordTime) {
                             studentSummary[name].lastRecordId = record.id;
                        }
                    }
                });
            });

            let no = 1;
            for (const name in studentSummary) {
                const summary = studentSummary[name];
                
                const row = rekapBody.insertRow();
                row.setAttribute('data-siswa', name); 
                row.setAttribute('data-kelas', selectedClass);
                
                row.onclick = (event) => {
                    if (event.target.tagName !== 'BUTTON') {
                        showSiswaDetailCumulative(name, selectedClass);
                    }
                };

                row.insertCell().textContent = no++;
                row.insertCell().textContent = name;
                row.insertCell().textContent = summary.H;
                row.insertCell().textContent = summary.I;
                row.insertCell().textContent = summary.S;
                row.insertCell().textContent = summary.A;
                row.insertCell().textContent = summary.B;
                
                // Menampilkan Total Absen (Jam)
                row.insertCell().textContent = summary.jamAbsenKumulatif + ' Jam'; 

                const actionCell = row.insertCell();
                if (summary.lastRecordId) {
                    actionCell.innerHTML = `
                        <button class="btn btn-edit btn-sm" onclick="event.stopPropagation(); handleEditRecord(${summary.lastRecordId})"><i class="fas fa-pencil-alt"></i> Edit Terakhir</button>
                    `;
                } else {
                    actionCell.textContent = '-';
                }
            }
        }
        
        function showSiswaDetailCumulative(siswaName, kelas) {
            const detailBox = document.getElementById('detail-absensi');
            
            const recordsInClass = storedAbsences.filter(r => r.kelas === kelas);
            
            let studentAttendanceHistory = [];
            let cumulativeSummary = { H: 0, I: 0, S: 0, A: 0, B: 0, jamAbsen: 0 };

            recordsInClass.forEach(record => {
                const detail = record.detail.find(d => d.nama === siswaName);
                if (detail) {
                    studentAttendanceHistory.push({
                        tanggal: record.tanggal,
                        mapel: record.mapel,
                        guru: record.guru,
                        jamke: record.jamke,
                        status: detail.status,
                        keterangan: detail.keterangan,
                        jamAbsen: detail.jamAbsen
                    });
                    
                    cumulativeSummary[detail.status]++;
                    cumulativeSummary.jamAbsen += detail.jamAbsen;
                }
            });
            
            studentAttendanceHistory.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            if (studentAttendanceHistory.length === 0) {
                detailBox.innerHTML = `<h3>Riwayat Absensi ${siswaName} (${kelas})</h3><p>Belum ada riwayat absensi untuk siswa ini.</p>`;
                detailBox.style.display = 'block';
                return;
            }


            // Jam Kumulatif tetap ditampilkan di DETAIL BOX
            let detailContent = `
                <h3>Riwayat Absensi Kumulatif: ${siswaName} (${kelas})</h3>
                <p>Ringkasan Total:</p>
                <ul>
                    <li>**Total Sesi Pertemuan Dihadiri/Diabsen:** **${studentAttendanceHistory.length} Sesi**</li> 
                    <li>**Hadir (H):** ${cumulativeSummary.H} Sesi</li>
                    <li>**Izin (I):** ${cumulativeSummary.I} Sesi</li>
                    <li>**Sakit (S):** ${cumulativeSummary.S} Sesi</li>
                    <li>**Absen (A/Alfa):** ${cumulativeSummary.A} Sesi</li>
                    <li>**Bolos (B):** ${cumulativeSummary.B} Sesi</li>
                    <li>**Total Jam Absen Kumulatif:** **${cumulativeSummary.jamAbsen} Jam**</li>
                </ul>
                <hr>
                <h4>Detail Per Sesi Mata Pelajaran (Terbaru ke Terlama):</h4>
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>Tgl</th>
                            <th>Mata Pelajaran / Guru</th>
                            <th>Jam Ke-</th>
                            <th>Status</th>
                            <th>Jam Absen</th>
                            <th>Keterangan</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            studentAttendanceHistory.forEach((history) => {
                let statusColor = '';
                if (history.status === 'H') statusColor = 'style="color: var(--color-green); font-weight: bold;"';
                if (history.status === 'A' || history.status === 'B') statusColor = 'style="color: var(--color-red); font-weight: bold;"';

                detailContent += `
                    <tr>
                        <td>${history.tanggal}</td>
                        <td style="text-align: left; font-size: 0.9em;">**${history.mapel}**<br><small>(${history.guru})</small></td>
                        <td>${history.jamke}</td>
                        <td ${statusColor}>${history.status}</td>
                        <td>${history.jamAbsen}</td>
                        <td>${history.keterangan || '-'}</td>
                    </tr>
                `;
            });

            detailContent += `
                    </tbody>
                </table>
            `;

            detailBox.innerHTML = detailContent;
            detailBox.style.display = 'block';
        }
        
        function handleEditRecord(recordId) {
            const record = storedAbsences.find(r => r.id === recordId);
            if (record) {
                setEditMode(record);
            } else {
                alert('Record tidak ditemukan.');
            }
        }
        
        // --- FUNGSI HAPUS PERMANEN ---
        function clearAllAbsences() {
            const confirmed = confirm("‚ö†Ô∏è PERINGATAN KERAS! Anda yakin ingin menghapus SEMUA data absensi yang tersimpan secara permanen? Tindakan ini tidak dapat dibatalkan.");
            
            if (confirmed) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                storedAbsences = [];
                memuatRekapan(); // Muat ulang tabel rekap yang kosong
                
                const deleteNotif = document.getElementById('delete-notification');
                deleteNotif.innerHTML = `<i class="fas fa-check-circle"></i> **SEMUA DATA ABSENSI BERHASIL DIHAPUS PERMANEN.**`;
                deleteNotif.style.display = 'block';
                
                setTimeout(() => {
                    deleteNotif.style.display = 'none';
                }, 5000);
            } else {
                alert("Penghapusan data dibatalkan.");
            }
        }

        // --- FUNGSI EKSPOR ---

        // Fungsi Ekspor ke Excel (XLSX)
        function exportToExcel() {
            const table = document.querySelector('.rekap-table');
            if (!table || table.rows.length <= 1) {
                alert("Tidak ada data rekapitulasi untuk diunduh. Silakan klik 'Muat Rekapan' terlebih dahulu.");
                return;
            }
            
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap_Kehadiran");
            
            const selectedClass = document.getElementById('rekap-kelas').value;
            const fileName = `Rekap_Absensi_${selectedClass}_${new Date().toISOString().slice(0, 10)}.xlsx`;

            XLSX.writeFile(wb, fileName);
            alert(`File Excel ${fileName} berhasil diunduh ke perangkat Anda.`);
        }

        // Fungsi Ekspor ke PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape, 'a4' size
            
            const selectedClass = document.getElementById('rekap-kelas').value;
            const date = new Date().toLocaleDateString('id-ID');
            const title = `REKAPITULASI KEHADIRAN SISWA KELAS ${selectedClass.toUpperCase()}`;
            
            doc.setFontSize(16);
            doc.text(title, 148.5, 15, null, null, 'center'); 
            doc.setFontSize(10);
            doc.text(`Tanggal Unduh: ${date}`, 148.5, 22, null, null, 'center'); 

            doc.autoTable({
                html: '.rekap-table',
                startY: 30,
                theme: 'striped',
                headStyles: { fillColor: [30, 136, 229] }, // Warna biru
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    1: { cellWidth: 40 }, // Lebar kolom Nama Siswa
                    // Kolom ke-8 (indeks 8) adalah 'Aksi Terakhir'
                },
                didParseCell: function(data) {
                    // Hilangkan kolom Aksi Terakhir dari PDF (Index 8)
                    if (data.column.index === 8) { 
                        data.cell.content = [];
                    }
                }
            });
            
            const fileName = `Rekap_Absensi_${selectedClass}_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(fileName);
            alert(`File PDF ${fileName} berhasil diunduh ke perangkat Anda.`);
        }
        
        function cetakOtomatis() {
            alert("Membuka dialog cetak otomatis. Pastikan Anda sudah mengklik 'Muat Rekapan' untuk melihat data yang ingin dicetak.");
            // window.print(); // Kode cetak sebenarnya
        }


        // Inisialisasi: Muat data dari storage, set tanggal, dan render tabel
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Muat data dari Local Storage
            loadAbsences();
            
            // 2. Set tanggal hari ini
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').value = today;
            document.getElementById('rekap-tanggal-akhir').value = today; 
            
            // 3. Render tabel absensi default
            renderAttendanceTable(activeClass);

            // 4. Event listener untuk filter kelas pada halaman rekap
            document.getElementById('rekap-kelas').addEventListener('change', memuatRekapan);
            
            console.log(`Data absensi yang dimuat: ${storedAbsences.length} record.`);
        });
    </script>
</body>
</html>